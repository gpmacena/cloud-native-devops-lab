---
- name: "Instalação da Stack de Monitoramento"
  hosts: all
  become: yes
  tasks:
    - name: Criar namespace de monitoramento
      shell: kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

    - name: Instalar Prometheus Operator (Correção de Namespace e Tamanho)
      shell: |
        curl -s https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/bundle.yaml | \
        sed 's/namespace: default/namespace: monitoring/g' | \
        kubectl apply --server-side --force-conflicts -f -

    - name: Aguardar o Operador ficar pronto
      shell: kubectl wait --for=condition=available --timeout=60s deployment/prometheus-operator -n monitoring

    - name: Criar Instância do Prometheus
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: monitoring.coreos.com/v1
        kind: Prometheus
        metadata:
          name: prometheus
          namespace: monitoring
        spec:
          serviceAccountName: prometheus-operator
          resources:
            requests:
              memory: 400Mi
        EOF

    - name: Deploy Grafana e Datasource
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/bibinwilson/kubernetes-grafana/master/grafana-datasource-config.yaml
        kubectl apply -f https://raw.githubusercontent.com/bibinwilson/kubernetes-grafana/master/deployment.yaml
        kubectl apply -f https://raw.githubusercontent.com/bibinwilson/kubernetes-grafana/master/service.yaml